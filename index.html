<!DOCTYPE html>
<html>
  <head>
    <title>
      The Permissions API
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' class=
    'remove'>
</script>
    <script class='remove'>
// (this is to make tidy happy)
    var respecConfig = {
        specStatus:           "unofficial",
        shortName:            "permissions",

        //publishDate:          "2014-04-03",
        //previousPublishDate:  "2014-02-20",
        //previousMaturity:     "WD",
        edDraftURI:           "https://w3c.github.io/permissions/",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "20015-08-05",
        noIDLIn:       true,
        noLegacyStyle: true,

        editors:  [
            {
              name: "Mounir Lamouri",
              company: "Google Inc.",
              companyURL: "http://google.com/",
            },
            {
              name: "Marcos CÃ¡ceres",
              company: "Mozilla",
              companyURL: "http://mozilla.com/",
            }
        ],

        otherLinks: [{
            key: 'Participate',
            data: [{
                      value: 'We are on Github.',
                      href: 'https://github.com/w3c/permissions'
                  }, {
                      value: 'File a bug.',
                      href: 'https://github.com/w3c/permissions/issues'
                  }, {
                      value: 'Commit history.',
                      href: 'https://github.com/w3c/permissions/commits/gh-pages'
                  }, {
                      value: 'Mailing list.',
                      href: 'http://lists.w3.org/Archives/Public/public-webapps/'
                  }]
        },{
            key: 'Implementation status',
            data: [{
                value: "Blink/Chromium",
                href: "https://code.google.com/p/chromium/issues/detail?id=437770"
            }, {
                value: "Gecko",
                href: "https://bugzilla.mozilla.org/show_bug.cgi?id=1105827"
            }]
        }],
        wg:           "Web Applications Working Group",
        wgURI:        "http://www.w3.org/2008/webapps/",
        wgPublicList: "public-webapps",
        wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/42538/status",
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      The <cite>Permissions API</cite> allows a web application to be aware of
      the status of a given permission, to know whether it is granted, denied
      or if the user will be asked whether the permission should be granted.
    </section>
    <section id='conformance'>
      <p>
        This specification defines conformance criteria that apply to a single
        product: the <dfn>user agent</dfn> that implements the interfaces that
        it contains.
      </p>
      <p>
        Implementations that use ECMAScript to expose the APIs defined in this
        specification MUST implement them in a manner consistent with the
        ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL]].
      </p>
    </section>
    <section>
      <h2>
        Dependencies
      </h2>
      <p>
        The following concepts and interfaces are defined in [[!HTML]]:
      </p>
      <ul>
        <li>
          <a href=
          'https://html.spec.whatwg.org/multipage/browsers.html#origin-2'><dfn>origin</dfn></a>
          of a <a href=
          'https://html.spec.whatwg.org/multipage/dom.html#document'><dfn>Document</dfn></a>
          and a <a href=
          'https://html.spec.whatwg.org/multipage/workers.html#workers'><dfn>worker</dfn></a>.
        </li>
        <li>
          <dfn><a href=
          "https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">
          queue a task</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">
          fire a simple event</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "https://html.spec.whatwg.org/multipage/webappapis.html#event-handlers">
          event handler</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-event-type">
          event handler event type</a></dfn>
        </li>
        <li>
          <code><dfn><a href=
          'https://html.spec.whatwg.org/multipage/browsers.html#window'>Window</a></dfn></code>
        </li>
      </ul>
      <p>
        <a href=
        'http://people.mozilla.org/~jorendorff/es6-draft.html#sec-promise-objects'>
        <dfn>Promise</dfn> objects</a> are defined in [[!ECMASCRIPT]].
      </p>
    </section>
    <section>
      <h2>
        Permission Registry
      </h2>
      <dl class='idl' title='enum PermissionName'>
        <dt>
          geolocation
        </dt>
        <dt>
          notifications
        </dt>
        <dt>
          push
        </dt><!--
          Other candidates:
           - Quota API
           - storage related (unlimited, ...)
           - registerProtocolHandler
           - getUserMedia (audio vs video)
        -->
      </dl>
      <p>
        The <code>PermissionName</code> enum defines the list of known
        permissions. Specifications are welcome to request a new name to be
        added to this registry instead of trying to monkey patch it.
      </p>
      <p>
        The <code><dfn id=
        'idl-def-PermissionName.geolocation'>geolocation</dfn></code>
        permission is the permission associated with the usage of the
        [[geolocation-API]].
      </p>
      <p>
        The <code><dfn id=
        'idl-def-PermissionName.notifications'>notifications</dfn></code>
        permission is the permission associated with the usage of the
        [[notifications]] API.
      </p>
      <p>
        The <code><dfn id='idl-def-PermissionName.push'>push</dfn></code>
        permission is the permission associated with the usage of the
        [[push-api]].
      </p>
    </section>
    <section>
      <h2>
        Permission definition
      </h2>
      <dl class='idl' title='dictionary Permission'>
        <dt>
          required PermissionName <a>name</a>
        </dt>
      </dl>
      <p>
        A <code>Permission</code> dictionary MUST contain a <code><dfn id=
        'widl-Permission-name'>name</dfn></code> field which represents the
        permission's identifier.
      </p>
      <p>
        If a permission has to be defined by more than its name, it is
        RECOMMENDED to inherit from <code>Permission</code> dictionary and add
        new fields.
      </p>
      <div class='issue'>
        Create an extensibility section? Maybe examples?
      </div>
    </section>
    <section>
      <h2>
        Status of a permission
      </h2>
      <dl class='idl' title='enum PermissionState'>
        <dt>
          granted
        </dt>
        <dt>
          denied
        </dt>
        <dt>
          prompt
        </dt>
      </dl>
      <p>
        The steps to <dfn>retrieve the permission state</dfn> of an
        <a>origin</a> for a given <code>permission-name</code> are as follows:
      </p>
      <ol>
        <li>If the <a>user agent</a> will allow the <a>origin</a> to try to
        access the feature associated with the <code>permission-name</code> but
        would prompt the user to know whether the call should succeed or fail,
        the <a>user agent</a> MUST return <code><dfn id=
        'widl-PermissionState-prompt'>prompt</dfn></code>.
        </li>
        <li>Otherwise, if the <a>user agent</a> will allow the <a>origin</a> to
        access the feature associated with the <code>permission-name</code>
        without prompting the user, the <a>user agent</a> MUST return
        <code><dfn id='widl-PermissionState-granted'>granted</dfn></code> .
        </li>
        <li>Otherwise, the <a>user agent</a> will not allow the <a>origin</a>
        to access the feature associated with <code>permission-name</code> and
        MUST return <code><dfn id=
        'widl-PermissionState-denied'>denied</dfn></code> .
        </li>
      </ol>
      <div class='issue'>
        What about pickers? So far, the supported features are not implemented
        as pickers but should we add a picker entry or should we expect those
        features to not use this API?<br>
        Using <code>granted</code> or <code>prompt</code> both have advantages
        and inconveniences in the sense that the picker model is exactly in
        between: the user is nagged and can still reject the call (like
        <code>prompt</code>) but authors can't do anything about it (like
        <code>granted</code>) assuming the picker would always show up.
      </div>
      <div class='issue'>
        What about permissions that are related to the current context like
        whether the call happens because of a user interaction? For example,
        fullscreen.
      </div>
      <dl class='idl' title='interface PermissionStatus : EventTarget'>
        <dt>
          readonly attribute PermissionName name
        </dt>
        <dt>
          readonly attribute PermissionState status
        </dt>
        <dt>
          attribute EventHandler onchange
        </dt>
      </dl>
      <p>
        A <code>PermissionStatus</code> instance has an <dfn>associated
        origin</dfn> that is defined when it is created.
      </p>
      <p>
        The steps to <dfn>update the status</dfn> of a
        <code>PermissionStatus</code> instance are as follow:
      </p>
      <ol>
        <li>Let <var>status</var> be the <code>PermissionStatus</code> instance
        being updated.
        </li>
        <li>Run the steps to <a>retrieve the permission state</a> using the
        <var>status</var> <a>associated origin</a> and <code>name</code>
        attribute then set the result of those steps to the <code>status</code>
        attribute.
        </li>
      </ol>
      <p>
        The steps to <dfn>create a PermissionStatus</dfn> for a given
        <a>origin</a> and <code>permission-name</code> are as follow:
      </p>
      <ol>
        <li>Let <var>status</var> be a <code>PermissionStatus</code> instance.
        </li>
        <li>Set <a>origin</a> as <var>status</var>'s <a>associated origin</a>.
        </li>
        <li>Set the <code>name</code> attribute to
        <code>permission-name</code>.
        </li>
        <li>Run the steps to <a>update the status</a> on <var>status</var>.
        </li>
        <li>Return <var>status</var>.
        </li>
      </ol>
      <p>
        The <code><dfn id='widl-PermissionStatus-name'>name</dfn></code>
        attribute MUST return the value it was initially set to at the object
        creation.
      </p>
      <p>
        The <code><dfn id='widl-PermissionStatus-status'>status</dfn></code>
        attribute MUST return the latest value that was set while running the
        <a>update the status</a> steps on the current instance.
      </p>
      <p>
        The <code><dfn id=
        'widl-PermissionStatus-onchange'>onchange</dfn></code> attribute is an
        <a>event handler</a> whose corresponding <a>event handler event
        type</a> is <code>change</code>.
      </p>
      <p>
        Whenever the <a>user agent</a> is aware that the <code>status</code> of
        a <code>PermissionStatus</code> instance has changed, it MUST
        asynchronously run the following steps:
      </p>
      <ol>
        <li>Let <var>permission-status</var> be the
        <code>PermissionStatus</code> for which the <code>status</code> has
        changed.
        </li>
        <li>Run the steps to <a>update the status</a> of
        <var>permission-status</var>.
        </li>
        <li>
          <a>Queue a task</a> on the <dfn>permission task source</dfn> to
          <a>fire a simple event</a> named <code>change</code> at
          <var>permission-status</var>.
        </li>
      </ol>
      <div class='issue'>
        What if a <code>Permission</code> has extended attributes? Should the
        <code>PermissionStatus</code> add them? How to specify that?
      </div>
    </section>
    <section>
      <h2>
        Permissions interface
      </h2>
      <dl class='idl' title='[Exposed=(Window,Worker)] interface Permissions'>
        <dt>
          static Promise&lt;PermissionStatus&gt; check((Permission or PermissionName) permission)
        </dt>
      </dl>
      <p>
        When the <code><dfn id='widl-Permissions-get-Promise-PermissionStatus--Permission-permission'>
        check()</dfn></code> method is invoked, the <a>user agent</a> MUST run the
        following steps:
      </p>
      <ol>
        <li>Let <var>origin</var> be the <code><a>Document</a></code>'s
        <a>origin</a> if those steps are run in a <code><a>Window</a></code>
        context or the <code><a>Worker</a></code>'s origin otherwise.
        </li>
        <li>Let <var>name</var> be <code>permission</code> if
        <var>permission</var> is of type <code>PermissionName</code>,
        <code>permission.name</code> otherwise.
        </li>
        <li>Let <var>promise</var> be a newly-created <a>Promise</a>.
        </li>
        <li>Return <var>promise</var> and continue those steps asynchronously.
        </li>
        <li>Run the steps to <a>create a PermissionStatus</a> using
        <var>origin</var> and <code>name</code> and resolve <var>promise</var>
        with the result of those steps.
        </li>
      </ol>
      <div class='issue'>
        The spec isn't really using <code>Permission</code>.
      </div>
    </section>
    <section class='informative'>
      <h2>
        Examples
      </h2>
      <p>
        This example uses the Permissions API to decide whether local news
        should be shown using the Geolocation API or a button offering that
        feature should be added.
      </p>
      <pre class='example highlight'>
&lt;script&gt;
  Permissions.check('geolocation').then(function(result) {
    if (result.status == 'granted') {
      showLocalNewsWithGeolocation();
    } else if (result.status == 'prompt') {
      showButtonToEnableLocalNews();
    }
    // Don't do anything if the permission was denied.
  });
&lt;/script&gt;
      
</pre>
      <p>
        This example is using the <code>capture-video</code> permission (does
        not actually exist) for a chat application to show a video chat button
        depending on the permission status.
      </p>
      <pre class='example highlight'>
&lt;script&gt;
  function updateVideoButton(permission) {
    document.getElementById('video-chat').disabled = (permission.status == 'denied');
  }

  Permissions.check('capture-video').then(function(result) {
    updateVideoButton(result);

    result.addEventListener('change', function() {
      updateVideoButton(this);
    });
  });
&lt;/script&gt;
      
</pre>
      <div class='issue'>
        Use a real permission on the example above.
      </div>
    </section>
    <section class='appendix'>
      <h2>
        Acknowledgments
      </h2>
      <p>
        Thanks to Adrienne Porter Felt, Jake Archibald and Marcos CÃ¡ceres for
        their early support and help.
      </p>
    </section>
  </body>
</html>
